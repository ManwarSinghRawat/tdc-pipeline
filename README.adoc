= TDC Cars

image:https://travis-ci.org/rmpestano/tdc-pipeline.svg[Build Status (Travis CI), link=https://travis-ci.org/rmpestano/tdc-pipeline]
image:https://coveralls.io/repos/rmpestano/tdc-pipeline/badge.png[Coverage, link=https://coveralls.io/r/rmpestano/tdc-pipeline]


Sample application for JavaEE Pipeline as code presentation.


== Running the application

IMPORTANT: You need `Docker`, `Maven` and `Java` installed on your machine.

All commands below must be executed in project root folder.

. Create a (filesystem) database using Flyway:
+
----
mvn flyway:migrate -P migrations -D db.path=~/db
----
After that, a file named `cars.h2.db` will be created on your `home/db` folder.
+
NOTE: your user must have write permissions in `~/db` directory.
TIP: If you are on a non unix OS like Windows you must change `db.path` to an existing directory e.g: db.path=C:/db
. Create application binary with:
+
----
mvn clean package
----
+
[IMPORTANT]
====
If you have changed *db.path* in migrations command you must build the application with the same param:

----
mvn clean package -D db.path=C:/db
----

====
. Now create a docker image using:
+
----
docker build -t tdc-pipeline .
----

. And finally run the application:
+
----
docker run -it --name tdc-pipeline -p 8080:8080 -v ~/db:/opt/jboss/db tdc-pipeline
----
+
NOTE: `-v ~/db:/opt/jboss/db` maps our host filesystem database (the one we created with Flyway) to docker container home dir so we can exit the container without losing data.
+
NOTE: `/opt/jboss/` is the home dir (`~/`) in wildfly docker container.
+
. Access the application at http://localhost:8080/tdc-pipeline

== Running tests

=== Integration tests

Tests in this application use Arquillian, http://arquillian.org/guides/getting_started_rinse_and_repeat/[see this guide^] if you never heard about it.

. Initialize database
+
----
 mvn flyway:clean flyway:migrate -Pmigrations -Ddb.name=cars-test
----
. Run the tests
+
----
mvn clean test -Pit-tests
----
+
[TIP]
====
If you want to run the test using an already running server activate `wildfly-remote` profile:

----
mvn clean test -Pit-tests -Pwildfly-remote
----
====

TIP: For `it tests` the database migration can be run only once to create tables. DataSets are prepared by http://arquillian.org/arquillian-extension-persistence/[Arquillian Persistence^].

=== Functional tests

. Initialize database
+
----
 mvn flyway:clean flyway:migrate -Pmigrations -Ddb.name=cars-ft-test
----
. Run the tests
+
----
mvn clean test -Pft-tests
----

TIP: For `ft tests` the database migration is required to be run every time the tests are run because Arquillian Persistence https://issues.jboss.org/browse/ARQ-1077[is not enabled in functional tests^].

=== Performance tests

Perf tests use Gatling tool, https://gatling.io[see it's web site^] to get an idea if you never head about it.

. Initialize database
+
----
 mvn flyway:clean flyway:migrate -Pmigrations -Ddb.name=cars
----
. <<Running the application,Deploy the application>>

. Run the tests
+
----
mvn clean gatling:execute -Pperf
----

== Running the pipeline

This application comes with a https://jenkins.io/doc/book/pipeline/syntax/[Jenkins declarative pipeline^]. Below are the step to run the pipeline locally.


=== Jenkins

First thing that is needed is a Jenkins instance, http://mirrors.jenkins.io/war-stable/latest/jenkins.war[download Jenkins here^] and start it on port `8080` using Java:

----
java -jar jenkins.war
----

[NOTE]
====
It was tested with `jenkins 2.73.2` with following plugins installed:

* Last Changes (http://updates.jenkins-ci.org/latest/last-changes.hpi[link to download^])
* Cucumber living documentation (http://updates.jenkins-ci.org/latest/cucumber-living-documentation.hpi[link to download^])
* Gatling (http://updates.jenkins-ci.org/latest/gatling.hpi[link to download^])
* Slack (http://updates.jenkins-ci.org/latest/slack.hpi[link to download^])
* Sonar (http://updates.jenkins-ci.org/latest/sonar.hpi[link to download^])
* Quality gates (http://updates.jenkins-ci.org/latest/quality-gates.hpi[link to download^])

====


=== Docker

This pipeline depends on Docker, install it according to your operating system https://docs.docker.com/engine/installation[as described here].

TIP: look for Docker CE (community edition).

TIP: To run docker without sudo https://askubuntu.com/questions/477551/how-can-i-use-docker-without-sudo[look here^].

=== Sonar

The pipeline depends on ht[tps://www.sonarqube.org/Sonar^], you need to have an Sonar instance running on `http://localhost:9000`.

An easy way to start Sonar locally is just running it's docker container:

----
docker run -d --name sonarqube -p 9000:9000 -p 9092:9092 sonarqube:lts
----

=== Configure slack

This pipeline is integrated with https://slack.com/[slack^]. You'll need to configure your Jenkins instance to work with Slack, here are the steps:

. Install slack plugin on your Jenkins: https://wiki.jenkins.io/display/JENKINS/Slack+Plugin
. Create a Slack channel

=== Demo

Following is a demo video showing this pipeline:
